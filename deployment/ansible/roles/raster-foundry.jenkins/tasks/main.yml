---
- name: Disable authentication for login
  copy:
    src=files/config.xml
    dest=/var/lib/jenkins/config.xml
  notify:
    - Restart Jenkins

- name: Add Jenkins Nginx config
  template: src=jenkins.conf.j2
            dest=/etc/nginx/sites-available/jenkins.conf
  notify:
    - Restart Nginx

- name: Enable Jenkins Nginx config
  file: src=/etc/nginx/sites-available/jenkins.conf
        dest=/etc/nginx/sites-enabled/jenkins
        state=link
  notify:
    - Restart Nginx

- name: Setup hourly docker-gc cron task
  cron:
    name: "docker-gc"
    user: "{{ jenkins_name }}"
    special_time: "hourly"
    job: >
      /usr/bin/docker run
      --rm
      -v /var/run/docker.sock:/var/run/docker.sock
      -v /etc:/etc
      spotify/docker-gc
    state: "present"
  changed_when: False

- name: Restart Jenkins every 3 hours
  cron:
    name: "jenkins-restart"
    user: "{{ jenkins_name }}"
    hour: "*/3"
    minute: "0"
    job: >
      /usr/bin/java -jar {{ jenkins_cli_jar_path }}
      -s http://localhost:{{ jenkins_http_port }}
      restart
  changed_when: False
